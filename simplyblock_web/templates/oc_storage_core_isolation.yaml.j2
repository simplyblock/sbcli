apiVersion: batch/v1
kind: Job
metadata:
  name: {{ CORE_JOBNAME }}
  namespace: {{ NAMESPACE }}
spec:
  template:
    spec:
      restartPolicy: OnFailure
      nodeSelector:
        kubernetes.io/hostname: {{ HOSTNAME }}
      hostNetwork: true
      hostPID: true
      serviceAccountName: simplyblock-storage-node-sa
      tolerations:
        - effect: NoSchedule
          operator: Exists
        - effect: NoExecute
          operator: Exists
      volumes:
        - name: var-simplyblock
          hostPath:
            path: /var/simplyblock
      containers:
        - name: init-setup
          image: alpine/kubectl:1.34.1
          securityContext:
            privileged: true
          volumeMounts:
            - name: var-simplyblock
              mountPath: /var/simplyblock
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -e

              MARKER="/var/simplyblock/.cpu_isolation_applied"

              echo "--- Installing jq ---"
              apk add --no-cache jq

              echo "--- Checking if node was already configured ---"

              if [[ -f "$MARKER" ]]; then
                  echo "[INFO] Node already configured. Skipping sleep and exiting..."
                  exit 0
              fi

              echo "--- Reading isolated cores from config ---"
              CONFIG_FILE="/var/simplyblock/sn_config_file"

              if [[ ! -f "$CONFIG_FILE" ]]; then
                  echo "[ERROR] Config file $CONFIG_FILE not found."
                  exit 1
              fi

              ISOLATED_CORES=$(jq -r '.isolated_cores | join(",")' "$CONFIG_FILE")
              if [[ -z "$ISOLATED_CORES" ]]; then
                  echo "[ERROR] Could not extract isolated cores from $CONFIG_FILE"
                  exit 1
              fi

              echo "[INFO] Isolated cores to apply: $ISOLATED_CORES"

              cat <<EOF | kubectl apply -f -
              apiVersion: machineconfiguration.openshift.io/v1
              kind: MachineConfigPool
              metadata:
                name: worker-isolated-{{ HOSTNAME }}
              spec:
                machineConfigSelector:
                  matchExpressions:
                    - key: machineconfiguration.openshift.io/role
                      operator: In
                      values:
                        - worker
                        - worker-isolated-{{ HOSTNAME }}
                nodeSelector:
                  matchLabels:
                    kubernetes.io/hostname: {{ HOSTNAME }}
              EOF

              # Create the MachineConfig for CPU isolation and IOMMU settings
              cat <<EOF | kubectl apply -f -
              apiVersion: machineconfiguration.openshift.io/v1
              kind: MachineConfig
              metadata:
                name: worker-isolated-{{ HOSTNAME }}
                labels:
                  machineconfiguration.openshift.io/role: worker-isolated-{{ HOSTNAME }}
              spec:
                kernelArguments:
                  - "nohz_full=${ISOLATED_CORES}"
                  - "rcu_nocbs=${ISOLATED_CORES}"
                  - "isolcpus=${ISOLATED_CORES}"
                  - "intel_iommu=on"
                  - "iommu=pt"
              EOF

              # Create the KubeletConfig to enable static CPU manager
              cat <<EOF | kubectl apply -f -
              apiVersion: machineconfiguration.openshift.io/v1
              kind: KubeletConfig
              metadata:
                name: set-static-cpu-manager-{{ HOSTNAME }}
              spec:
                machineConfigPoolSelector:
                  matchLabels:
                    machineconfiguration.openshift.io/role: worker-isolated-{{ HOSTNAME }}
                kubeletConfig:
                  cpuManagerPolicy: static
                  cpuManagerReconcilePeriod: 5s
              EOF

              echo "[INFO] Init setup and CPU isolation complete."
              
              echo "[INFO] Marking node as configured."
              touch "$MARKER"

              echo "[INFO] Node is rebooting. Sleeping for 5 minutes to stop pipeline gracefully..."
              sleep 300