apiVersion: batch/v1
kind: Job
metadata:
  name: {{ JOBNAME }}
  namespace: {{ NAMESPACE }}
spec:
  template:
    spec:
      restartPolicy: OnFailure
      nodeSelector:
        kubernetes.io/hostname: {{ HOSTNAME }}
      hostNetwork: true
      hostPID: true
      serviceAccountName: simplyblock-storage-node-sa
      tolerations:
        - effect: NoSchedule
          operator: Exists
        - effect: NoExecute
          operator: Exists
      volumes:
        - name: etc-systemd
          hostPath:
            path: /etc/systemd/
      containers:
        - name: init-setup
          image: simplyblock/ubuntu-tools:22.04
          securityContext:
            privileged: true
          volumeMounts:
            - name: etc-systemd
              mountPath: /etc/systemd/
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -e

              echo "--- Starting init setup ---"
              
              NODE_IP=$(ip route get 1.1.1.1 | grep -oE 'src [0-9.]+' | awk '{print $2}')
              echo "Detected node IP: $NODE_IP"

              echo "--- Sending config to $NODE_IP ---"
              RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://$NODE_IP:5000/snode/apply_config -H "Content-Type: application/json" -d '{}')
              echo "HTTP status: $RESPONSE"
              if [ "$RESPONSE" -lt 200 ] || [ "$RESPONSE" -ge 300 ]; then
                echo "Failed to apply config"
                exit 1
              fi
              
              echo "--- Checking OS ---"
              OS_ID="$(cat /proc/version | awk '{print $3}' | awk -F'-' '{print $NF}')"

              if [ "$OS_ID" != "talos" ]; then

                echo "--- Creating RAM disk systemd unit on host ---"

                nsenter --target 1 --mount --uts --ipc --net --pid -- /bin/sh -c '
                  set -e

                  UNIT_PATH="/etc/systemd/system/var-mnt-ramdisk.mount"

                  echo "Writing systemd unit to $UNIT_PATH"

                  cat <<EOF > "$UNIT_PATH"
                  [Unit]
                  Description=1G RAM disk at /var/mnt/ramdisk
                  After=local-fs-pre.target
                  Before=local-fs.target

                  [Mount]
                  What=tmpfs
                  Where=/var/mnt/ramdisk
                  Type=tmpfs
                  Options=size=1G,mode=1777

                  [Install]
                  WantedBy=local-fs.target
                  EOF

                  echo "Reloading systemd..."
                  systemctl daemon-reload || echo "systemd reload failed"

                  echo "Enabling mount unit..."
                  systemctl enable var-mnt-ramdisk.mount || echo "enable failed"

                  echo "Starting mount unit..."
                  systemctl start var-mnt-ramdisk.mount || echo "start failed (check logs or unit file)"

                  echo "RAM disk mounting completed."
                '

                echo "--- Restarting kubelet ---"
                nsenter --target 1 --mount --uts --ipc --net --pid -- /bin/sh -c '
                  if command -v systemctl >/dev/null 2>&1; then
                    echo "Restarting kubelet..."
                    systemctl restart kubelet && echo "Kubelet restarted" || echo "Kubelet restart failed"
                  else
                    echo "systemctl not found; skipping kubelet restart"
                  fi
                '
              else
                echo "Talos detected - skipping nsenter and kubelet restart."
                echo "Use '\''talosctl service kubelet restart -n $NODE_IP'\'' to restart the node kubelet"
              fi

              echo "--- Init setup complete ---"
