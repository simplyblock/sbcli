name: Deploy cluster

on:
  workflow_call:
    inputs:
      runs_on:  # Has to be an input
        description: Platform to execute on
        type: string
        default: ubuntu-latest
      cluster:
        required: true
        type: string
      docker_image:
        required: true
        type: string
      sbcli_source:
        required: true
        type: string
      ndcs:
        required: false
        type: string
        default: 1
      npcs:
        required: false
        type: string
        default: 1
      bs:
        required: false
        type: string
        default: 4096
      chunk_bs:
        required: false
        type: string
        default: 4096
      nr_hugepages:
        required: false
        type: string
        default: 2048

    outputs:
      cluster_ip:
        description: "The cluster's IP"
        value: ${{ jobs.deploy.outputs.cluster_ip }}
      cluster_id:
        description: "The cluster's ID"
        value: ${{ jobs.deploy.outputs.cluster_id }}
      cluster_secret:
        description: "The cluster secret"
        value: ${{ jobs.deploy.outputs.cluster_secret }}
      mnodes:
        description: "The IP of management nodes"
        value: ${{ jobs.deploy.outputs.mnodes }}
      storage_private_ips:
        description: "The private IPs of the storage nodes"
        value: ${{ jobs.deploy.outputs.storage_private_ips }}

jobs:
  deploy:
    runs-on: ${{ inputs.runs_on }}

    outputs:
      cluster_id: ${{ steps.deployment.outputs.cluster_id }}
      cluster_ip: ${{ steps.deployment.outputs.cluster_ip }}
      cluster_secret: ${{ steps.deployment.outputs.cluster_secret }}
      mnodes: ${{ steps.deployment.outputs.mnodes }}
      storage_private_ips: ${{ steps.deployment.outputs.storage_private_ips }}

    steps:
    - name: Checkout sbcli
      uses: actions/checkout@v4
      with:
        path: sbcli

    - name: Checkout deployment tooling
      uses: actions/checkout@v4
      with:
        repository: simplyblock-io/simplyBlockDeploy
        path: deploy

    - name: Deploy cluster
      id: deployment
      run: |
        cd deploy/bare-metal
        eval $(python3 inventory.py inventory/${{ inputs.cluster }}.yml)
        ./bootstrap-cluster.sh --max-lvol 100 --max-snap 100 --max-size 400G --number-of-devices 3 --sbcli-cmd sbctl --spdk-debug --journal-partition 0 --ha-type ha
        echo "mnodes=$MNODES" >> ${GITHUB_OUTPUT:-/dev/stdout}
        echo "storage_private_ips=${STORAGE_PRIVATE_IPS}" >> ${GITHUB_OUTPUT:-/dev/stdout}
      env:
        NDCS: ${{ inputs.ndcs }}
        NPCS: ${{ inputs.npcs }}
        BS: ${{ inputs.bs }}
        CHUNK_BS: ${{ inputs.chunk_bs }}
        NR_HUGEPAGES: ${{ inputs.nr_hugepages }}
        SBCLI_BRANCH: ${{ inputs.sbcli_source }}
        SIMPLY_BLOCK_DOCKER_IMAGE: ${{ inputs.docker_image }}
