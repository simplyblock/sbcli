---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-admin-control
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-admin-control
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
        reloader.stakater.com/auto: "true"
        reloader.stakater.com/configmap: "simplyblock-fdb-cluster-config"
      labels:
        app: simplyblock-admin-control
    spec:
      serviceAccountName: simplyblock-control-sa
      containers:
      - name: simplyblock-control
        image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
        imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
        command: ["sleep", "infinity"]
        env:
        - name: K8S_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: MONITORING_SECRET
          valueFrom:
            secretKeyRef:
              name: simplyblock-grafana-secrets
              key: MONITORING_SECRET
        - name: SIMPLYBLOCK_LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: simplyblock-config
              key: LOG_LEVEL
        volumeMounts:
        - name: fdb-cluster-file
          mountPath: /etc/foundationdb/fdb.cluster
          subPath: fdb.cluster
        resources:
          requests:
            cpu: "200m"
            memory: "256Mi"
          limits:
            cpu: "600m"
            memory: "1Gi"
      volumes:
      - name: fdb-cluster-file
        configMap:
          name: simplyblock-fdb-cluster-config
          items:
            - key: cluster-file
              path: fdb.cluster
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: simplyblock-webappapi
  namespace: {{ .Release.Namespace }}
spec:
  selector:
    matchLabels:
      app: simplyblock-webappapi
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
        reloader.stakater.com/auto: "true"
        reloader.stakater.com/configmap: "simplyblock-fdb-cluster-config"
      labels:
        app: simplyblock-webappapi
    spec:       
      containers:
      - name: webappapi
        image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
        imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
        ports:
        - containerPort: 5000
        command: ["python", "simplyblock_web/app.py"]
        env:
        - name: SIMPLYBLOCK_LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: simplyblock-config
              key: LOG_LEVEL
        - name: FLASK_DEBUG
          value: "False"
        - name: FLASK_ENV
          value: "production"
        volumeMounts:
        - name: fdb-cluster-file
          mountPath: /etc/foundationdb/fdb.cluster
          subPath: fdb.cluster
        resources:
          requests:
            cpu: "200m"
            memory: "512Mi"
          limits:
            cpu: "500m"
            memory: "2Gi"
      volumes:
      - name: fdb-cluster-file
        configMap:
          name: simplyblock-fdb-cluster-config
          items:
            - key: cluster-file
              path: fdb.cluster
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-storage-node-monitor
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-storage-node-monitor
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
        reloader.stakater.com/auto: "true"
        reloader.stakater.com/configmap: "simplyblock-fdb-cluster-config"
      labels:
        app: simplyblock-storage-node-monitor
    spec:
      containers:
      - name: storage-node-monitor
        image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
        imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
        command: ["python", "simplyblock_core/services/storage_node_monitor.py"]
        env:
        - name: SIMPLYBLOCK_LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: simplyblock-config
              key: LOG_LEVEL
        volumeMounts:
        - name: fdb-cluster-file
          mountPath: /etc/foundationdb/fdb.cluster
          subPath: fdb.cluster
        resources:
          requests:
            cpu: "200m"
            memory: "256Mi"
          limits:
            cpu: "400m"
            memory: "1Gi"
      volumes:
      - name: fdb-cluster-file
        configMap:
          name: simplyblock-fdb-cluster-config
          items:
            - key: cluster-file
              path: fdb.cluster
      
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-mgmt-node-monitor
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-mgmt-node-monitor
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
        reloader.stakater.com/auto: "true"
        reloader.stakater.com/configmap: "simplyblock-fdb-cluster-config"
      labels:
        app: simplyblock-mgmt-node-monitor
    spec:
      containers:
        - name: mgmt-node-monitor
          image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
          imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
          command: ["python", "simplyblock_core/services/mgmt_node_monitor.py"]
          env:
          - name: BACKEND_TYPE
            value: "k8s"
          - name: SIMPLYBLOCK_LOG_LEVEL
            valueFrom:
              configMapKeyRef:
                name: simplyblock-config
                key: LOG_LEVEL
          volumeMounts:
          - name: fdb-cluster-file
            mountPath: /etc/foundationdb/fdb.cluster
            subPath: fdb.cluster
          resources:
            requests:
              cpu: "200m"
              memory: "256Mi"
            limits:
              cpu: "400m"
              memory: "1Gi"
      volumes:
      - name: fdb-cluster-file
        configMap:
          name: simplyblock-fdb-cluster-config
          items:
            - key: cluster-file
              path: fdb.cluster

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-lvol-stats-collector
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-lvol-stats-collector
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
        reloader.stakater.com/auto: "true"
        reloader.stakater.com/configmap: "simplyblock-fdb-cluster-config"
      labels:
        app: simplyblock-lvol-stats-collector
    spec:
      containers:
        - name: lvol-stats-collector
          image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
          imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
          command: ["python", "simplyblock_core/services/lvol_stat_collector.py"]
          env:
          - name: SIMPLYBLOCK_LOG_LEVEL
            valueFrom:
              configMapKeyRef:
                name: simplyblock-config
                key: LOG_LEVEL
          volumeMounts:
          - name: fdb-cluster-file
            mountPath: /etc/foundationdb/fdb.cluster
            subPath: fdb.cluster
          resources:
            requests:
              cpu: "200m"
              memory: "256Mi"
            limits:
              cpu: "400m"
              memory: "1Gi"
      volumes:
      - name: fdb-cluster-file
        configMap:
          name: simplyblock-fdb-cluster-config
          items:
            - key: cluster-file
              path: fdb.cluster

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-main-distr-event-collector
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-main-distr-event-collector
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
        reloader.stakater.com/auto: "true"
        reloader.stakater.com/configmap: "simplyblock-fdb-cluster-config"
      labels:
        app: simplyblock-main-distr-event-collector
    spec:      
      containers:
        - name: main-distr-event-collector
          image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
          imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
          command: ["python", "simplyblock_core/services/main_distr_event_collector.py"]
          env:
          - name: SIMPLYBLOCK_LOG_LEVEL
            valueFrom:
              configMapKeyRef:
                name: simplyblock-config
                key: LOG_LEVEL
          volumeMounts:
          - name: fdb-cluster-file
            mountPath: /etc/foundationdb/fdb.cluster
            subPath: fdb.cluster
          resources:
            requests:
              cpu: "200m"
              memory: "256Mi"
            limits:
              cpu: "400m"
              memory: "1Gi"
      volumes:
      - name: fdb-cluster-file
        configMap:
          name: simplyblock-fdb-cluster-config
          items:
            - key: cluster-file
              path: fdb.cluster

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-capacity-and-stats-collector
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-capacity-and-stats-collector
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
        reloader.stakater.com/auto: "true"
        reloader.stakater.com/configmap: "simplyblock-fdb-cluster-config"
      labels:
        app: simplyblock-capacity-and-stats-collector
    spec:      
      containers:
      - name: capacity-and-stats-collector
        image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
        imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
        command: ["python", "simplyblock_core/services/capacity_and_stats_collector.py"]
        env:
        - name: SIMPLYBLOCK_LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: simplyblock-config
              key: LOG_LEVEL
        volumeMounts:
        - name: fdb-cluster-file
          mountPath: /etc/foundationdb/fdb.cluster
          subPath: fdb.cluster
        resources:
          requests:
            cpu: "200m"
            memory: "256Mi"
          limits:
            cpu: "400m"
            memory: "1Gi"
      volumes:
      - name: fdb-cluster-file
        configMap:
          name: simplyblock-fdb-cluster-config
          items:
            - key: cluster-file
              path: fdb.cluster

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-capacity-monitor
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-capacity-monitor
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
        reloader.stakater.com/auto: "true"
        reloader.stakater.com/configmap: "simplyblock-fdb-cluster-config"
      labels:
        app: simplyblock-capacity-monitor
    spec:
      
      containers:
      - name: capacity-monitor
        image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
        imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
        command: ["python", "simplyblock_core/services/cap_monitor.py"]
        env:
        - name: SIMPLYBLOCK_LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: simplyblock-config
              key: LOG_LEVEL
        volumeMounts:
        - name: fdb-cluster-file
          mountPath: /etc/foundationdb/fdb.cluster
          subPath: fdb.cluster
        resources:
          requests:
            cpu: "200m"
            memory: "256Mi"
          limits:
            cpu: "400m"
            memory: "1Gi"
      volumes:
      - name: fdb-cluster-file
        configMap:
          name: simplyblock-fdb-cluster-config
          items:
            - key: cluster-file
              path: fdb.cluster

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-health-check
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-health-check
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
        reloader.stakater.com/auto: "true"
        reloader.stakater.com/configmap: "simplyblock-fdb-cluster-config"
      labels:
        app: simplyblock-health-check
    spec:      
      containers:
      - name: health-check
        image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
        imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
        command: ["python", "simplyblock_core/services/health_check_service.py"]
        env:
        - name: SIMPLYBLOCK_LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: simplyblock-config
              key: LOG_LEVEL
        volumeMounts:
        - name: fdb-cluster-file
          mountPath: /etc/foundationdb/fdb.cluster
          subPath: fdb.cluster
        resources:
          requests:
            cpu: "200m"
            memory: "256Mi"
          limits:
            cpu: "400m"
            memory: "1Gi"
      volumes:
      - name: fdb-cluster-file
        configMap:
          name: simplyblock-fdb-cluster-config
          items:
            - key: cluster-file
              path: fdb.cluster

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-device-monitor
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-device-monitor
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
        reloader.stakater.com/auto: "true"
        reloader.stakater.com/configmap: "simplyblock-fdb-cluster-config"
      labels:
        app: simplyblock-device-monitor
    spec:      
      containers:
      - name: device-monitor
        image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
        imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
        command: ["python", "simplyblock_core/services/device_monitor.py"]
        env:
          - name: SIMPLYBLOCK_LOG_LEVEL
            valueFrom:
              configMapKeyRef:
                name: simplyblock-config
                key: LOG_LEVEL
        volumeMounts:
        - name: fdb-cluster-file
          mountPath: /etc/foundationdb/fdb.cluster
          subPath: fdb.cluster
        resources:
          requests:
            cpu: "200m"
            memory: "256Mi"
          limits:
            cpu: "400m"
            memory: "1Gi"
      volumes:
      - name: fdb-cluster-file
        configMap:
          name: simplyblock-fdb-cluster-config
          items:
            - key: cluster-file
              path: fdb.cluster

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-lvol-monitor
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-lvol-monitor
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
        reloader.stakater.com/auto: "true"
        reloader.stakater.com/configmap: "simplyblock-fdb-cluster-config"
      labels:
        app: simplyblock-lvol-monitor
    spec:      
      containers:
      - name: lvol-monitor
        image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
        imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
        command: ["python", "simplyblock_core/services/lvol_monitor.py"]
        env:
        - name: SIMPLYBLOCK_LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: simplyblock-config
              key: LOG_LEVEL
        volumeMounts:
        - name: fdb-cluster-file
          mountPath: /etc/foundationdb/fdb.cluster
          subPath: fdb.cluster
        resources:
          requests:
            cpu: "200m"
            memory: "256Mi"
          limits:
            cpu: "400m"
            memory: "1Gi"
      volumes:
      - name: fdb-cluster-file
        configMap:
          name: simplyblock-fdb-cluster-config
          items:
            - key: cluster-file
              path: fdb.cluster
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-snapshot-monitor
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-snapshot-monitor
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
        reloader.stakater.com/auto: "true"
        reloader.stakater.com/configmap: "simplyblock-fdb-cluster-config"
      labels:
        app: simplyblock-snapshot-monitor
    spec:     
      containers:
      - name: snapshot-monitor
        image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
        imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
        command: ["python", "simplyblock_core/services/snapshot_monitor.py"]
        env:
        - name: SIMPLYBLOCK_LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: simplyblock-config
              key: LOG_LEVEL
        volumeMounts:
        - name: fdb-cluster-file
          mountPath: /etc/foundationdb/fdb.cluster
          subPath: fdb.cluster
        resources:
          requests:
            cpu: "200m"
            memory: "256Mi"
          limits:
            cpu: "400m"
            memory: "1Gi"
      volumes:
      - name: fdb-cluster-file
        configMap:
          name: simplyblock-fdb-cluster-config
          items:
            - key: cluster-file
              path: fdb.cluster
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-cleanupfdb
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-cleanupfdb
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
        reloader.stakater.com/auto: "true"
        reloader.stakater.com/configmap: "simplyblock-fdb-cluster-config"
      labels:
        app: simplyblock-cleanupfdb
    spec:      
      containers:
        - name: cleanupfdb
          image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
          imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
          command: ["python", "simplyblock_core/workers/cleanup_foundationdb.py"]
          env:
            - name: SIMPLYBLOCK_LOG_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: simplyblock-config
                  key: LOG_LEVEL
            - name: LOG_DELETION_INTERVAL
              value: "${LOG_DELETION_INTERVAL}"
          volumeMounts:
          - name: fdb-cluster-file
            mountPath: /etc/foundationdb/fdb.cluster
            subPath: fdb.cluster
          resources:
            requests:
              cpu: "200m"
              memory: "256Mi"
            limits:
              cpu: "400m"
              memory: "1Gi"
      volumes:
      - name: fdb-cluster-file
        configMap:
          name: simplyblock-fdb-cluster-config
          items:
            - key: cluster-file
              path: fdb.cluster

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-tasks-runner-restart
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-tasks-runner-restart
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
        reloader.stakater.com/auto: "true"
        reloader.stakater.com/configmap: "simplyblock-fdb-cluster-config"
      labels:
        app: simplyblock-tasks-runner-restart
    spec:     
      containers:
        - name: tasks-runner-restart
          image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
          imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
          command: ["python", "simplyblock_core/services/tasks_runner_restart.py"]
          env:
            - name: SIMPLYBLOCK_LOG_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: simplyblock-config
                  key: LOG_LEVEL
          volumeMounts:
          - name: fdb-cluster-file
            mountPath: /etc/foundationdb/fdb.cluster
            subPath: fdb.cluster
          resources:
            requests:
              cpu: "200m"
              memory: "256Mi"
            limits:
              cpu: "400m"
              memory: "1Gi"
      volumes:
      - name: fdb-cluster-file
        configMap:
          name: simplyblock-fdb-cluster-config
          items:
            - key: cluster-file
              path: fdb.cluster

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-tasks-runner-migration
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-tasks-runner-migration
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
        reloader.stakater.com/auto: "true"
        reloader.stakater.com/configmap: "simplyblock-fdb-cluster-config"
      labels:
        app: simplyblock-tasks-runner-migration
    spec:      
      containers:
        - name: tasks-runner-migration
          image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
          imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
          command: ["python", "simplyblock_core/services/tasks_runner_migration.py"]
          env:
            - name: SIMPLYBLOCK_LOG_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: simplyblock-config
                  key: LOG_LEVEL
          volumeMounts:
          - name: fdb-cluster-file
            mountPath: /etc/foundationdb/fdb.cluster
            subPath: fdb.cluster
          resources:
            requests:
              cpu: "200m"
              memory: "256Mi"
            limits:
              cpu: "400m"
              memory: "1Gi"
      volumes:
      - name: fdb-cluster-file
        configMap:
          name: simplyblock-fdb-cluster-config
          items:
            - key: cluster-file
              path: fdb.cluster
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-tasks-runner-failed-migration
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-tasks-runner-failed-migration
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
        reloader.stakater.com/auto: "true"
        reloader.stakater.com/configmap: "simplyblock-fdb-cluster-config"
      labels:
        app: simplyblock-tasks-runner-failed-migration
    spec:      
      containers:
        - name: tasks-runner-failed-migration
          image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
          imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
          command: ["python", "simplyblock_core/services/tasks_runner_failed_migration.py"]
          env:
            - name: SIMPLYBLOCK_LOG_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: simplyblock-config
                  key: LOG_LEVEL
          volumeMounts:
          - name: fdb-cluster-file
            mountPath: /etc/foundationdb/fdb.cluster
            subPath: fdb.cluster
          resources:
            requests:
              cpu: "200m"
              memory: "256Mi"
            limits:
              cpu: "400m"
              memory: "1Gi"
      volumes:
      - name: fdb-cluster-file
        configMap:
          name: simplyblock-fdb-cluster-config
          items:
            - key: cluster-file
              path: fdb.cluster
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-tasks-runner-cluster-status
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-tasks-runner-cluster-status
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
        reloader.stakater.com/auto: "true"
        reloader.stakater.com/configmap: "simplyblock-fdb-cluster-config"
      labels:
        app: simplyblock-tasks-runner-cluster-status
    spec:      
      containers:
        - name: tasks-runner-cluster-status
          image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
          imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
          command: ["python", "simplyblock_core/services/tasks_cluster_status.py"]
          env:
            - name: SIMPLYBLOCK_LOG_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: simplyblock-config
                  key: LOG_LEVEL
          volumeMounts:
          - name: fdb-cluster-file
            mountPath: /etc/foundationdb/fdb.cluster
            subPath: fdb.cluster
          resources:
            requests:
              cpu: "200m"
              memory: "256Mi"
            limits:
              cpu: "400m"
              memory: "1Gi"
      volumes:
      - name: fdb-cluster-file
        configMap:
          name: simplyblock-fdb-cluster-config
          items:
            - key: cluster-file
              path: fdb.cluster
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-tasks-runner-new-device-migration
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-tasks-runner-new-device-migration
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
        reloader.stakater.com/auto: "true"
        reloader.stakater.com/configmap: "simplyblock-fdb-cluster-config"
      labels:
        app: simplyblock-tasks-runner-new-device-migration
    spec:      
      containers:
        - name: tasks-runner-new-device-migration
          image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
          imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
          command: ["python", "simplyblock_core/services/tasks_runner_new_dev_migration.py"]
          env:
            - name: SIMPLYBLOCK_LOG_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: simplyblock-config
                  key: LOG_LEVEL
          volumeMounts:
          - name: fdb-cluster-file
            mountPath: /etc/foundationdb/fdb.cluster
            subPath: fdb.cluster
          resources:
            requests:
              cpu: "200m"
              memory: "256Mi"
            limits:
              cpu: "400m"
              memory: "1Gi"
      volumes:
      - name: fdb-cluster-file
        configMap:
          name: simplyblock-fdb-cluster-config
          items:
            - key: cluster-file
              path: fdb.cluster
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-tasks-node-add-runner
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-tasks-node-add-runner
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
        reloader.stakater.com/auto: "true"
        reloader.stakater.com/configmap: "simplyblock-fdb-cluster-config"
      labels:
        app: simplyblock-tasks-node-add-runner
    spec:      
      containers:
        - name: tasks-node-addrunner
          image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
          imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
          command: ["python", "simplyblock_core/services/tasks_runner_node_add.py"]
          env:
            - name: SIMPLYBLOCK_LOG_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: simplyblock-config
                  key: LOG_LEVEL
          volumeMounts:
          - name: fdb-cluster-file
            mountPath: /etc/foundationdb/fdb.cluster
            subPath: fdb.cluster
          resources:
            requests:
              cpu: "200m"
              memory: "256Mi"
            limits:
              cpu: "400m"
              memory: "1Gi"
      volumes:
      - name: fdb-cluster-file
        configMap:
          name: simplyblock-fdb-cluster-config
          items:
            - key: cluster-file
              path: fdb.cluster

---

apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: simplyblock-fluent-bit
  namespace: {{ .Release.Namespace }}
  labels:
    app: simplyblock-fluent-bit
spec:
  selector:
    matchLabels:
      app: simplyblock-fluent-bit
  template:
    metadata:
      labels:
        app: simplyblock-fluent-bit
    spec:      
      containers:
        - name: fluent-bit
          image: fluent/fluent-bit:1.8.11
          securityContext:
            privileged: true
          volumeMounts:
            - name: varlog
              mountPath: /var/log
            - name: varlibdockercontainers
              mountPath: /var/lib/docker/containers
              readOnly: true
            - name: config
              mountPath: /fluent-bit/etc/
          resources:
            requests:
              cpu: "200m"
              memory: "400Mi"
            limits:
              cpu: "400m"
              memory: "1Gi"
      volumes:
        - name: varlog
          hostPath:
            path: /var/log
        - name: varlibdockercontainers
          hostPath:
            path: /var/lib/docker/containers
        - name: config
          configMap:
            name: simplyblock-fluent-bit-config
