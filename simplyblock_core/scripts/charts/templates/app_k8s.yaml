# ---
# apiVersion: apps/v1
# kind: DaemonSet
# metadata:
#   name: simplyblock-fdb-server
#   namespace: {{ .Release.Namespace }}
# spec:
#   selector:
#     matchLabels:
#       app: simplyblock-fdb-server
#   template:
#     metadata:
#       labels:
#         app: simplyblock-fdb-server
#       annotations:
#         log-collector/enabled: "true"
#     spec:
#       nodeSelector:
#         simplyblock.io/role: mgmt-plane
#       containers:
#       - name: fdb-server
#         image: foundationdb/foundationdb:7.3.42
#         ports:
#         - containerPort: 4500
#         env:
#         - name: PUBLIC_IP
#           valueFrom:
#             fieldRef:
#               fieldPath: status.hostIP
#         - name: SIMPLYBLOCK_LOG_LEVEL
#           valueFrom:
#             configMapKeyRef:
#               name: simplyblock-config
#               key: LOG_LEVEL
#         - name: FDB_CLUSTER_FILE_CONTENTS
#           valueFrom:
#             configMapKeyRef:
#               name: simplyblock-config
#               key: FDB_CLUSTER_FILE_CONTENTS
#         - name: FDB_CLUSTER_FILE
#           value: "/etc/foundationdb/fdb.cluster"
#         - name: FDB_NETWORKING_MODE
#           value: "container"
#         volumeMounts:
#           - name: fdb-data
#             mountPath: /var/fdb/data
#           - name: fdb-logs
#             mountPath: /var/fdb/logs
#           - name: fdb-entrypoint                     
#             mountPath: /var/fdb/scripts
#             readOnly: true
#           - name: fdb-config
#             mountPath: /etc/foundationdb
            
#         resources:
#           requests:
#             cpu: "100m"
#             memory: "512Mi"
#           limits:
#             cpu: "500m"
#             memory: "2Gi"
#       volumes:
#       - name: fdb-entrypoint                         
#         configMap:
#           name: simplyblock-fdb-entrypoint-script
#           defaultMode: 0777
#       - name: fdb-data
#         hostPath:
#           path: /var/lib/foundationdb/data
#           type: DirectoryOrCreate
#       - name: fdb-logs
#         hostPath:
#           path: /var/log/foundationdb
#           type: DirectoryOrCreate
#       - name: fdb-tls
#         hostPath:
#           path: /var/lib/foundationdb/tls
#           type: DirectoryOrCreate
#       - name: fdb-config
#         hostPath:
#           path: /var/foundationdb
#       hostNetwork: true

# ---
# apiVersion: apps/v1
# kind: Deployment
# metadata:
#   name: simplyblock-fdb-backup-agent
#   namespace: {{ .Release.Namespace }}
# spec:
#   replicas: 1
#   selector:
#     matchLabels:
#       app: simplyblock-fdb-backup-agent
#   template:
#     metadata:
#       annotations:
#         log-collector/enabled: "true"
#       labels:
#         app: simplyblock-fdb-backup-agent
#     spec:
#       nodeSelector:
#         simplyblock.io/role: mgmt-plane 
#       containers:
#       - name: fdb-backup-agent
#         image: foundationdb/foundationdb:7.3.42
#         command: ["/usr/bin/backup_agent", "-C", "/etc/foundationdb/fdb.cluster"]
#         env:
#         - name: FDB_CLUSTER_FILE
#           value: "/etc/foundationdb/fdb.cluster"
#         - name: FDB_CLUSTER_FILE_CONTENTS
#           valueFrom:
#             configMapKeyRef:
#               name: simplyblock-config
#               key: FDB_CLUSTER_FILE_CONTENTS
#         volumeMounts:
#           - name: foundationdb
#             mountPath: /etc/foundationdb
#         resources:
#           requests:
#             cpu: "100m"
#             memory: "256Mi"
#           limits:
#             cpu: "250m"
#             memory: "1Gi"
#       volumes:
#       - name: foundationdb
#         hostPath:
#           path: /var/foundationdb
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: simplyblock-webappapi
  namespace: {{ .Release.Namespace }}
spec:
  selector:
    matchLabels:
      app: simplyblock-webappapi
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
      labels:
        app: simplyblock-webappapi
    spec:
      nodeSelector:
        simplyblock.io/role: mgmt-plane 
      containers:
      - name: webappapi
        image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
        imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
        ports:
        - containerPort: 5000
        command: ["python", "simplyblock_web/app.py"]
        env:
        - name: SIMPLYBLOCK_LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: simplyblock-config
              key: LOG_LEVEL
        - name: FLASK_DEBUG
          value: "False"
        - name: FLASK_ENV
          value: "production"
        volumeMounts:
        # - name: fdb-config
        # #   mountPath: /etc/foundationdb
        - name: fdb-cluster-file
          mountPath: /etc/foundationdb
          subPath: fdb.cluster
        resources:
          requests:
            cpu: "100m"
            memory: "512Mi"
          limits:
            cpu: "500m"
            memory: "2Gi"
      volumes:
      # - name: fdb-config
      #   hostPath:
      #     path: /var/foundationdb
      - name: fdb-cluster-file
        configMap:
          name: simplyblock-fdb-cluster-config
          items:
            - key: cluster-file
              path: fdb.cluster
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-storage-node-monitor
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-storage-node-monitor
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
      labels:
        app: simplyblock-storage-node-monitor
    spec:
      nodeSelector:
        simplyblock.io/role: mgmt-plane 
      containers:
      - name: storage-node-monitor
        image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
        imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
        command: ["python", "simplyblock_core/services/storage_node_monitor.py"]
        env:
        - name: SIMPLYBLOCK_LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: simplyblock-config
              key: LOG_LEVEL
        volumeMounts:
        - name: fdb-config
          mountPath: /etc/foundationdb
        resources:
          requests:
            cpu: "100m"
            memory: "256Mi"
          limits:
            cpu: "250m"
            memory: "1Gi"
      volumes:
      - name: fdb-config
        hostPath:
          path: /var/foundationdb
      
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-mgmt-node-monitor
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-mgmt-node-monitor
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
      labels:
        app: simplyblock-mgmt-node-monitor
    spec:
      nodeSelector:
        simplyblock.io/role: mgmt-plane
      containers:
        - name: mgmt-node-monitor
          image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
          imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
          command: ["python", "simplyblock_core/services/mgmt_node_monitor.py"]
          env:
          - name: BACKEND_TYPE
            value: "k8s"
          - name: SIMPLYBLOCK_LOG_LEVEL
            valueFrom:
              configMapKeyRef:
                name: simplyblock-config
                key: LOG_LEVEL
          volumeMounts:
            - name: foundationdb
              mountPath: /etc/foundationdb
          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "250m"
              memory: "1Gi"
      volumes:
        - name: foundationdb
          hostPath:
            path: /var/foundationdb

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-lvol-stats-collector
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-lvol-stats-collector
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
      labels:
        app: simplyblock-lvol-stats-collector
    spec:
      nodeSelector:
        simplyblock.io/role: mgmt-plane
      containers:
        - name: lvol-stats-collector
          image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
          imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
          command: ["python", "simplyblock_core/services/lvol_stat_collector.py"]
          env:
          - name: SIMPLYBLOCK_LOG_LEVEL
            valueFrom:
              configMapKeyRef:
                name: simplyblock-config
                key: LOG_LEVEL
          volumeMounts:
            - name: foundationdb
              mountPath: /etc/foundationdb
          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "250m"
              memory: "1Gi"
      volumes:
        - name: foundationdb
          hostPath:
            path: /var/foundationdb

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-main-distr-event-collector
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-main-distr-event-collector
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
      labels:
        app: simplyblock-main-distr-event-collector
    spec:
      nodeSelector:
        simplyblock.io/role: mgmt-plane
      containers:
        - name: main-distr-event-collector
          image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
          imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
          command: ["python", "simplyblock_core/services/main_distr_event_collector.py"]
          env:
          - name: SIMPLYBLOCK_LOG_LEVEL
            valueFrom:
              configMapKeyRef:
                name: simplyblock-config
                key: LOG_LEVEL
          volumeMounts:
            - name: foundationdb
              mountPath: /etc/foundationdb
          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "250m"
              memory: "1Gi"
      volumes:
        - name: foundationdb
          hostPath:
            path: /var/foundationdb

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-capacity-and-stats-collector
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-capacity-and-stats-collector
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
      labels:
        app: simplyblock-capacity-and-stats-collector
    spec:
      nodeSelector:
        simplyblock.io/role: mgmt-plane
      containers:
      - name: capacity-and-stats-collector
        image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
        imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
        command: ["python", "simplyblock_core/services/capacity_and_stats_collector.py"]
        env:
        - name: SIMPLYBLOCK_LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: simplyblock-config
              key: LOG_LEVEL
        volumeMounts:
        - name: foundationdb
          mountPath: /etc/foundationdb
        resources:
          requests:
            cpu: "100m"
            memory: "256Mi"
          limits:
            cpu: "250m"
            memory: "1Gi"
      volumes:
      - name: foundationdb
        hostPath:
          path: /var/foundationdb

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-capacity-monitor
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-capacity-monitor
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
      labels:
        app: simplyblock-capacity-monitor
    spec:
      nodeSelector:
        simplyblock.io/role: mgmt-plane
      containers:
      - name: capacity-monitor
        image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
        imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
        command: ["python", "simplyblock_core/services/cap_monitor.py"]
        env:
        - name: SIMPLYBLOCK_LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: simplyblock-config
              key: LOG_LEVEL
        volumeMounts:
        - mountPath: /etc/foundationdb
          name: foundationdb
        resources:
          requests:
            cpu: "100m"
            memory: "256Mi"
          limits:
            cpu: "250m"
            memory: "1Gi"
      volumes:
      - name: foundationdb
        hostPath:
          path: /var/foundationdb

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-health-check
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-health-check
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
      labels:
        app: simplyblock-health-check
    spec:
      nodeSelector:
        simplyblock.io/role: mgmt-plane
      containers:
      - name: health-check
        image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
        imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
        command: ["python", "simplyblock_core/services/health_check_service.py"]
        env:
        - name: SIMPLYBLOCK_LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: simplyblock-config
              key: LOG_LEVEL
        volumeMounts:
        - mountPath: /etc/foundationdb
          name: foundationdb
        resources:
          requests:
            cpu: "100m"
            memory: "256Mi"
          limits:
            cpu: "250m"
            memory: "1Gi"
      volumes:
      - name: foundationdb
        hostPath:
          path: /var/foundationdb

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-device-monitor
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-device-monitor
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
      labels:
        app: simplyblock-device-monitor
    spec:
      nodeSelector:
        simplyblock.io/role: mgmt-plane
      containers:
      - name: device-monitor
        image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
        imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
        command: ["python", "simplyblock_core/services/device_monitor.py"]
        env:
          - name: SIMPLYBLOCK_LOG_LEVEL
            valueFrom:
              configMapKeyRef:
                name: simplyblock-config
                key: LOG_LEVEL
        volumeMounts:
        - mountPath: /etc/foundationdb
          name: foundationdb
        resources:
          requests:
            cpu: "100m"
            memory: "256Mi"
          limits:
            cpu: "250m"
            memory: "1Gi"
      volumes:
      - name: foundationdb
        hostPath:
          path: /var/foundationdb

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-lvol-monitor
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-lvol-monitor
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
      labels:
        app: simplyblock-lvol-monitor
    spec:
      nodeSelector:
        simplyblock.io/role: mgmt-plane
      containers:
      - name: lvol-monitor
        image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
        imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
        command: ["python", "simplyblock_core/services/lvol_monitor.py"]
        env:
        - name: SIMPLYBLOCK_LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: simplyblock-config
              key: LOG_LEVEL
        volumeMounts:
        - mountPath: /etc/foundationdb
          name: foundationdb
        resources:
          requests:
            cpu: "100m"
            memory: "256Mi"
          limits:
            cpu: "250m"
            memory: "1Gi"
      volumes:
      - name: foundationdb
        hostPath:
          path: /var/foundationdb
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-snapshot-monitor
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-snapshot-monitor
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
      labels:
        app: simplyblock-snapshot-monitor
    spec:
      nodeSelector:
        simplyblock.io/role: mgmt-plane
      containers:
      - name: snapshot-monitor
        image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
        imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
        command: ["python", "simplyblock_core/services/snapshot_monitor.py"]
        env:
        - name: SIMPLYBLOCK_LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: simplyblock-config
              key: LOG_LEVEL
        volumeMounts:
        - mountPath: /etc/foundationdb
          name: foundationdb
        resources:
          requests:
            cpu: "100m"
            memory: "256Mi"
          limits:
            cpu: "250m"
            memory: "1Gi"
      volumes:
      - name: foundationdb
        hostPath:
          path: /var/foundationdb
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-cleanupfdb
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-cleanupfdb
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
      labels:
        app: simplyblock-cleanupfdb
    spec:
      nodeSelector:
        simplyblock.io/role: mgmt-plane
      containers:
        - name: cleanupfdb
          image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
          imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
          command: ["python", "simplyblock_core/workers/cleanup_foundationdb.py"]
          env:
            - name: SIMPLYBLOCK_LOG_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: simplyblock-config
                  key: LOG_LEVEL
            - name: LOG_DELETION_INTERVAL
              value: "${LOG_DELETION_INTERVAL}"
          volumeMounts:
            - name: foundationdb
              mountPath: /etc/foundationdb
          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "250m"
              memory: "1Gi"
      volumes:
        - name: foundationdb
          hostPath:
            path: /var/foundationdb

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-tasks-runner-restart
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-tasks-runner-restart
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
      labels:
        app: simplyblock-tasks-runner-restart
    spec:
      nodeSelector:
        simplyblock.io/role: mgmt-plane
      containers:
        - name: tasks-runner-restart
          image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
          imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
          command: ["python", "simplyblock_core/services/tasks_runner_restart.py"]
          env:
            - name: SIMPLYBLOCK_LOG_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: simplyblock-config
                  key: LOG_LEVEL
          volumeMounts:
            - name: foundationdb
              mountPath: /etc/foundationdb
          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "250m"
              memory: "1Gi"
      volumes:
        - name: foundationdb
          hostPath:
            path: /var/foundationdb

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-tasks-runner-migration
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-tasks-runner-migration
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
      labels:
        app: simplyblock-tasks-runner-migration
    spec:
      nodeSelector:
        simplyblock.io/role: mgmt-plane
      containers:
        - name: tasks-runner-migration
          image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
          imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
          command: ["python", "simplyblock_core/services/tasks_runner_migration.py"]
          env:
            - name: SIMPLYBLOCK_LOG_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: simplyblock-config
                  key: LOG_LEVEL
          volumeMounts:
            - name: foundationdb
              mountPath: /etc/foundationdb
          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "250m"
              memory: "1Gi"
      volumes:
        - name: foundationdb
          hostPath:
            path: /var/foundationdb
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-tasks-runner-failed-migration
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-tasks-runner-failed-migration
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
      labels:
        app: simplyblock-tasks-runner-failed-migration
    spec:
      nodeSelector:
        simplyblock.io/role: mgmt-plane
      containers:
        - name: tasks-runner-failed-migration
          image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
          imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
          command: ["python", "simplyblock_core/services/tasks_runner_failed_migration.py"]
          env:
            - name: SIMPLYBLOCK_LOG_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: simplyblock-config
                  key: LOG_LEVEL
          volumeMounts:
            - name: foundationdb
              mountPath: /etc/foundationdb
          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "250m"
              memory: "1Gi"
      volumes:
        - name: foundationdb
          hostPath:
            path: /var/foundationdb
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-tasks-runner-cluster-status
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-tasks-runner-cluster-status
  template:
    metadata:
      labels:
        app: simplyblock-tasks-runner-cluster-status
    spec:
      nodeSelector:
        simplyblock.io/role: mgmt-plane
      containers:
        - name: tasks-runner-cluster-status
          image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
          imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
          command: ["python", "simplyblock_core/services/tasks_cluster_status.py"]
          env:
            - name: SIMPLYBLOCK_LOG_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: simplyblock-config
                  key: LOG_LEVEL
          volumeMounts:
            - name: foundationdb
              mountPath: /etc/foundationdb
          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "250m"
              memory: "1Gi"
      volumes:
        - name: foundationdb
          hostPath:
            path: /var/foundationdb
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-tasks-runner-new-device-migration
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-tasks-runner-new-device-migration
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
      labels:
        app: simplyblock-tasks-runner-new-device-migration
    spec:
      nodeSelector:
        simplyblock.io/role: mgmt-plane
      containers:
        - name: tasks-runner-new-device-migration
          image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
          imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
          command: ["python", "simplyblock_core/services/tasks_runner_new_dev_migration.py"]
          env:
            - name: SIMPLYBLOCK_LOG_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: simplyblock-config
                  key: LOG_LEVEL
          volumeMounts:
            - name: foundationdb
              mountPath: /etc/foundationdb
          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "250m"
              memory: "1Gi"
      volumes:
        - name: foundationdb
          hostPath:
            path: /var/foundationdb
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simplyblock-tasks-node-add-runner
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simplyblock-tasks-node-add-runner
  template:
    metadata:
      annotations:
        log-collector/enabled: "true"
      labels:
        app: simplyblock-tasks-node-add-runner
    spec:
      nodeSelector:
        simplyblock.io/role: mgmt-plane
      containers:
        - name: tasks-node-addrunner
          image: "{{ .Values.image.simplyblock.repository }}:{{ .Values.image.simplyblock.tag }}"
          imagePullPolicy: "{{ .Values.image.simplyblock.pullPolicy }}"
          command: ["python", "simplyblock_core/services/tasks_runner_node_add.py"]
          env:
            - name: SIMPLYBLOCK_LOG_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: simplyblock-config
                  key: LOG_LEVEL
          volumeMounts:
            - name: foundationdb
              mountPath: /etc/foundationdb
          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "250m"
              memory: "1Gi"
      volumes:
        - name: foundationdb
          hostPath:
            path: /var/foundationdb

---

apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: simplyblock-fluent-bit
  namespace: {{ .Release.Namespace }}
  labels:
    app: simplyblock-fluent-bit
spec:
  selector:
    matchLabels:
      app: simplyblock-fluent-bit
  template:
    metadata:
      labels:
        app: simplyblock-fluent-bit
    spec:
      nodeSelector:
        simplyblock.io/role: mgmt-plane
      containers:
        - name: fluent-bit
          image: fluent/fluent-bit:1.8.11
          volumeMounts:
            - name: varlog
              mountPath: /var/log
            - name: varlibdockercontainers
              mountPath: /var/lib/docker/containers
              readOnly: true
            - name: config
              mountPath: /fluent-bit/etc/
          resources:
            requests:
              cpu: "100m"
              memory: "400Mi"
            limits:
              cpu: "250m"
              memory: "1Gi"
      volumes:
        - name: varlog
          hostPath:
            path: /var/log
        - name: varlibdockercontainers
          hostPath:
            path: /var/lib/docker/containers
        - name: config
          configMap:
            name: simplyblock-fluent-bit-config
